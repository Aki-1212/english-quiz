<!--AI正誤版（ひらがな未対応）連打防止付き-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>英単語クイズ</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      margin: 40px 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    #levelArea, #quizArea, #resultList {
      max-width: 700px;
      margin: 0 auto 40px auto;
      background: #fff;
      border-radius: 8px;
      padding: 20px 30px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h1, h2 {
      margin-bottom: 20px;
      color: #222;
    }
    button {
      margin: 8px 6px;
      padding: 12px 25px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #3b82f6;
      color: white;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button:hover {
      background-color: #2563eb;
    }
    #answer {
      font-size: 18px;
      padding: 10px 12px;
      width: 60%;
      max-width: 350px;
      margin: 10px 0 20px 0;
      border: 2px solid #3b82f6;
      border-radius: 5px;
      box-sizing: border-box;
    }
    #progress {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 15px;
      color: #555;
    }
    #levelDisplay {
      font-weight: bold;
      font-size: 20px;
      margin-bottom: 10px;
      color: #444;
    }
    #question {
      font-size: 28px;
      margin-bottom: 15px;
      font-weight: 600;
      color: #111;
    }
    #result {
      font-size: 20px;
      height: 28px;
      margin-bottom: 15px;
      font-weight: 600;
    }
    #resultList h2 {
      margin-bottom: 20px;
    }
    #resultsUl {
      list-style-type: none;
      padding-left: 0;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
    }
    #resultsUl li {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      font-size: 16px;
      line-height: 1.3;
    }
    #resultsUl li.correct {
      color: #059669; /* 緑 */
      background-color: #d1fae5;
    }
    #resultsUl li.incorrect {
      color: #dc2626; /* 赤 */
      background-color: #fee2e2;
    }
    #reviewBtn {
      margin-top: 15px;
      background-color: #ef4444;
    }
    #reviewBtn:hover {
      background-color: #b91c1c;
    }
    #backBtn {
      background-color: #6b7280;
      margin-top: 25px;
    }
    #backBtn:hover {
      background-color: #374151;
    }
    .correct {
      color: green;
      font-weight: bold;
    }
    .incorrect {
      color: red;
      font-weight: bold;
    }

    /* 🔹単語を非表示にするが余白を保つ */
  .hidden-word {
    color: transparent !important;
    user-select: none;
    transition: color 0.4s ease !important;
  }

/* 🔹答えたあとに表示（フェードイン） */
  .revealed {
    color: #111;
  }

    
    @media (max-width: 480px) {
      body {
        margin: 20px 10px;
        font-size: 14px;
      }
      #levelArea, #quizArea, #resultList {
        padding: 15px 20px;
        max-width: 100%;
      }
      #answer {
        width: 90%;
        max-width: none;
        font-size: 16px;
        padding: 8px 10px;
      }
      button {
        width: 90%;
        font-size: 16px;
        padding: 12px 0;
        margin: 10px auto;
        display: block;
      }
      #question {
        font-size: 22px;
      }
      #progress {
        font-size: 16px;
      }
      #result {
        font-size: 18px;
      }
      #resultsUl li {
        font-size: 14px;
        padding: 10px 12px;
      }
    }
    /* 🔈 英語音声再生ボタン */
#speakBtn {
  background: none;
  border: none;
  font-size: 22px;
  color: #3b82f6;
  cursor: pointer;
  padding: 0;
  margin: 0;
  line-height: 1;
  transition: transform 0.15s ease, color 0.15s ease, opacity 0.15s ease;
}

#speakBtn:hover {
  color: #2563eb;
  transform: scale(1.2);
  opacity: 0.9;
}

#speakBtn:active {
  transform: scale(0.9);
}

/* 🎧 再生中のアニメーション */
#speakBtn.speaking {
  color: #22c55e; /* 緑色 */
  animation: pulse 0.8s infinite;
}

/* 🔈 結果画面用の小さい音声ボタン */
.speak-small-btn {
  background: none;
  border: none;
  font-size: 18px;
  color: #3b82f6;
  cursor: pointer;
  margin-left: 6px;
  padding: 0;
  transition: transform 0.15s ease, color 0.15s ease;
}

.speak-small-btn:hover {
  color: #2563eb;
  transform: scale(1.2);
}

.speak-small-btn:active {
  transform: scale(0.9);
}

@media (max-width: 480px) {
  .speak-small-btn {
    font-size: 16px;
    margin-left: 4px;
  }
}


@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.3); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}

@media (max-width: 480px) {
  #speakBtn {
    font-size: 20px;
  }
}


  </style>
</head>
<body>

<div id="levelArea">
  <h1>範囲＆モード選択</h1>
  <div id="inputModeArea" style="margin-bottom: 20px;">
    <label><input type="radio" name="inputMode" value="normal" checked> 通常</label>
    <label><input type="radio" name="inputMode" value="sound"> 音声のみ</label>
  </div>
  
  <div id="modeSelector" style="margin-bottom: 20px;">
    <label><input type="radio" name="mode" value="word" checked> 単語のみ</label>
    <label><input type="radio" name="mode" value="both"> 熟語と単語</label>
    <label><input type="radio" name="mode" value="idiom"> 熟語のみ</label>
  </div>

  <h2>単語 1〜1700</h2>
  <script>
    for (let level = 1; level <= 17; level++) {
      const startNum = (level - 1) * 100 + 1;
      const midNum = startNum + 49;
      const endNum = level * 100;
      const jsonFile = `words_level${level}.json`;
      document.write(`<h3>単語 ${startNum}〜${endNum} （level${level}）</h3>`);
      document.write(`<button onclick="loadWords('${jsonFile}', ${startNum}, ${midNum}, ${level})">単語 ${startNum}〜${midNum}</button>`);
      document.write(`<button onclick="loadWords('${jsonFile}', ${midNum + 1}, ${endNum}, ${level})">単語 ${midNum + 1}〜${endNum}</button>`);
    }
  </script>
</div>

<div id="quizArea" style="display:none;">
  <p id="levelDisplay">レベル: -</p>
  <p id="progress">0 / 0</p>
  <button id="speakBtn" onclick="speakEnglish(document.getElementById('question').textContent)" title="発音を聞く">
    🔈
  </button>
  <p id="question">単語が表示されます</p>

  <input type="text" id="answer" placeholder="日本語で答えてください" autocomplete="off" />
  <br />
  <button id="answerBtn" onclick="checkAnswer()">答える</button>
  <p id="result"></p>
  <button id="backBtn" onclick="goBack()">← レベル選択に戻る</button>
</div>

<div id="resultList" style="display:none;">
  <h2>結果一覧</h2>
  <ul id="resultsUl"></ul>
  <button id="reviewBtn" style="display:none;" onclick="reviewWrong()">間違った問題を復習する</button>
  <br />
  <button id="backBtn" onclick="goBack()">← レベル選択に戻る</button>
</div>

<script>
let words = [];
let current = 0;
let correct = 0;
let answersLog = [];
let currentLevel = 0;

function levenshtein(a, b) {
  const matrix = [];
  for (let i = 0; i <= b.length; i++) matrix[i] = [i];
  for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      matrix[i][j] = b.charAt(i-1) === a.charAt(j-1)
        ? matrix[i-1][j-1]
        : Math.min(matrix[i-1][j-1] + 1, matrix[i][j-1] + 1, matrix[i-1][j] + 1);
    }
  }
  return matrix[b.length][a.length];
}

async function loadWords(file, startId, endId, level) {
  currentLevel = level;
  const res = await fetch(file);
  const data = await res.json();
  const selectedMode = document.querySelector('input[name="mode"]:checked').value;
  words = data.filter(word => {
    if (word.id < startId || word.id > endId) return false;
    if (selectedMode === "idiom") return word.idiom;
    if (selectedMode === "word") return !word.idiom;
    return true;
  });
  shuffle(words);
  current = 0;
  correct = 0;
  answersLog = [];

  document.getElementById("levelDisplay").textContent = `レベル: ${currentLevel}`;
  document.getElementById("levelArea").style.display = "none";
  document.getElementById("resultList").style.display = "none";
  document.getElementById("quizArea").style.display = "block";
  showQuestion();
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function showQuestion() {
  if (current >= words.length) {
    showResultList();
    return;
  }

  const currentWord = words[current].en; // 今回出題する単語
  const inputMode = document.querySelector('input[name="inputMode"]:checked').value;
  const questionElem = document.getElementById("question");

  // まず非表示状態にする
  questionElem.classList.add("hidden-word");
  questionElem.classList.remove("revealed");

  // 単語をセット（非表示状態で）
  questionElem.textContent = currentWord;

  // 通常モードなら少しフェードイン
  if (inputMode !== "sound") {
    setTimeout(() => {
      questionElem.classList.remove("hidden-word");
      questionElem.classList.add("revealed");
    }, 10); // 10msでクラス切替、CSSの transition でフェードイン
  }

  document.getElementById("progress").textContent = (current + 1) + " / " + words.length;
  document.getElementById("result").textContent = "";
  document.getElementById("answer").value = "";
  document.getElementById("answer").focus();

  // 音声再生
  speakEnglish(currentWord);
}




function removeParentheses(str) {
  return str.replace(/[\(\（].*?[\)\）]/g, "").trim();
}

async function getSimilarity(text1, text2) {
  const response = await fetch("https://english-quiz-smoky.vercel.app/api/hf-proxy", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ inputs: { source_sentence: text1, sentences: [text2] } })
  });
  const data = await response.json();
  if (!Array.isArray(data) || typeof data[0] !== "number") return 0;
  return data[0];
}

// 🔹連打防止付き checkAnswer
async function checkAnswer() {
  const answerBtn = document.getElementById("answerBtn");
  answerBtn.disabled = true;

  const userAnswer = document.getElementById("answer").value.trim().toLowerCase();
  const correctAnswers = words[current].jp;
  const resultElem = document.getElementById("result");
  const questionElem = document.getElementById("question");

  // 🔸音声モードなら単語を表示させる
  if (questionElem.classList.contains("hidden-word")) {
    questionElem.classList.remove("hidden-word");
    questionElem.classList.add("revealed");
  }

  if (userAnswer.length === 0) {
    resultElem.textContent = `ｘ (${correctAnswers.join(", ")})`;
    resultElem.className = "incorrect";
    answersLog.push({
      en: words[current].en,
      correctAnswer: correctAnswers.join(", "),
      userAnswer,
      isCorrect: false,
      id: words[current].id,
      jp: correctAnswers
    });
    current++;
    setTimeout(() => {
      answerBtn.disabled = false;
      showQuestion();
    }, 1000);
    return;
  }

  // ✅ 正誤判定
  let isCorrect = false;
  for (const ans of correctAnswers) {
    const cleaned = removeParentheses(ans).toLowerCase();
    const similarity = await getSimilarity(userAnswer, cleaned);
    if (similarity >= 0.85) {
      isCorrect = true;
      break;
    }
  }

  if (isCorrect) {
    correct++;
    resultElem.textContent = `〇 (${correctAnswers.join(", ")})`;
    resultElem.className = "correct";
  } else {
    resultElem.textContent = `ｘ (${correctAnswers.join(", ")})`;
    resultElem.className = "incorrect";
  }

  answersLog.push({
    en: words[current].en,
    correctAnswer: correctAnswers.join(", "),
    userAnswer,
    isCorrect,
    id: words[current].id,
    jp: correctAnswers
  });

  current++;
  setTimeout(() => {
    answerBtn.disabled = false;
    showQuestion();
  }, 1000);
}


function showResultList() {
  document.getElementById("quizArea").style.display = "none";
  const resultDiv = document.getElementById("resultList");
  const ul = document.getElementById("resultsUl");
  ul.innerHTML = "";

  answersLog.forEach((item, i) => {
    const li = document.createElement("li");
    li.className = item.isCorrect ? "correct" : "incorrect";

    // 🔹英単語テキスト
    const textSpan = document.createElement("span");
    textSpan.textContent = `${i + 1}. ${item.en} — あなたの答え: "${item.userAnswer || '未回答'}" — 正解: "${item.correctAnswer}"`;

    // 🔹再生ボタン
    const speakBtn = document.createElement("button");
    speakBtn.textContent = "🔈";
    speakBtn.className = "speak-small-btn";
    speakBtn.title = "発音を聞く";
    speakBtn.onclick = () => speakEnglish(item.en);

    // 🔹リストに追加
    li.appendChild(textSpan);
    li.appendChild(speakBtn);
    ul.appendChild(li);
  });

  const wrongCount = answersLog.filter(x => !x.isCorrect).length;
  document.getElementById("reviewBtn").style.display = wrongCount > 0 ? "inline-block" : "none";
  resultDiv.style.display = "block";
}


function reviewWrong() {
  words = answersLog.filter(x => !x.isCorrect).map(x => ({ id: x.id, en: x.en, jp: x.jp }));
  shuffle(words);
  current = 0; correct = 0; answersLog = [];
  document.getElementById("resultList").style.display = "none";
  document.getElementById("quizArea").style.display = "block";
  showQuestion();
}

function goBack() {
  document.getElementById("quizArea").style.display = "none";
  document.getElementById("resultList").style.display = "none";
  document.getElementById("levelArea").style.display = "block";
  document.getElementById("result").textContent = "";
  const answerInput = document.getElementById("answer");
  answerInput.value = "";
  answerInput.style.display = "inline";
  document.getElementById("answerBtn").style.display = "inline";
}

// 🔹Enterキーでも連打防止チェック
document.getElementById("answer").addEventListener("keydown", e => {
  const btn = document.getElementById("answerBtn");
  if (e.key === "Enter" && !btn.disabled) {
    e.preventDefault();
    checkAnswer();
  }
});

document.body.addEventListener("click", e => {
  const tag = e.target.tagName.toLowerCase();
  if (!["input", "button", "select", "textarea", "label", "a"].includes(tag)) {
    const ans = document.getElementById("answer");
    if (ans && ans.offsetParent !== null) ans.focus();
  }
});

const modeSelector = document.querySelectorAll('input[name="mode"]');
modeSelector.forEach(radio => {
  radio.addEventListener('change', async () => {
    const selectedMode = document.querySelector('input[name="mode"]:checked').value;
    for (let level = 1; level <= 17; level++) {
      const file = `words_level${level}.json`;
      const res = await fetch(file);
      const data = await res.json();
      const startNum = (level - 1) * 100 + 1;
      const midNum = startNum + 49;
      const endNum = level * 100;
      const ranges = [
        { start: startNum, end: midNum },
        { start: midNum + 1, end: endNum }
      ];
      ranges.forEach(range => {
        const hasIdiom = data.some(w => w.idiom && w.id >= range.start && w.id <= range.end);
        const hasWord = data.some(w => !w.idiom && w.id >= range.start && w.id <= range.end);
        const btnText = `単語 ${range.start}〜${range.end}`;
        const btns = Array.from(document.querySelectorAll('button')).filter(b => b.textContent === btnText);
        btns.forEach(btn => {
          if (selectedMode === 'idiom' && !hasIdiom) {
            btn.disabled = true; btn.style.opacity = 0.5; btn.title = 'この範囲には熟語がありません';
          } else if (selectedMode === 'word' && !hasWord) {
            btn.disabled = true; btn.style.opacity = 0.5; btn.title = 'この範囲には単語がありません';
          } else {
            btn.disabled = false; btn.style.opacity = 1; btn.title = '';
          }
        });
      });
    }
  });
});
modeSelector[0].dispatchEvent(new Event('change'));

  // ===== 英語音声を再生する関数 =====
function speakEnglish(text) {
  if (!('speechSynthesis' in window)) {
    console.warn('このブラウザは音声合成に対応していません。');
    return;
  }

  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'en-US';     // 英語
  utter.rate = 0.9;         // 話す速さ（1が普通、少しゆっくり）
  utter.pitch = 1;          // 声の高さ

  // 英語の声を優先して選択（例：Google US Englishなど）
  const voices = speechSynthesis.getVoices();
  const enVoice = voices.find(v => v.lang.startsWith('en'));
  if (enVoice) utter.voice = enVoice;

  speechSynthesis.cancel(); // 前の音声が残ってたら止める
  speechSynthesis.speak(utter);
}

</script>
</body>
</html>








