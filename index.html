<!--AIæ­£èª¤ç‰ˆï¼ˆã²ã‚‰ãŒãªæœªå¯¾å¿œï¼‰é€£æ‰“é˜²æ­¢ä»˜ã-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±å˜èªã‚¯ã‚¤ã‚º</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      margin: 40px 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    #levelArea, #quizArea, #resultList {
      max-width: 700px;
      margin: 0 auto 40px auto;
      background: #fff;
      border-radius: 8px;
      padding: 20px 30px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h1, h2 {
      margin-bottom: 20px;
      color: #222;
    }
    button {
      margin: 8px 6px;
      padding: 12px 25px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #3b82f6;
      color: white;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button:hover {
      background-color: #2563eb;
    }
    #answer {
      font-size: 18px;
      padding: 10px 12px;
      width: 60%;
      max-width: 350px;
      margin: 10px 0 20px 0;
      border: 2px solid #3b82f6;
      border-radius: 5px;
      box-sizing: border-box;
    }
    #progress {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 15px;
      color: #555;
    }
    #levelDisplay {
      font-weight: bold;
      font-size: 20px;
      margin-bottom: 10px;
      color: #444;
    }
    #question {
      font-size: 28px;
      margin-bottom: 15px;
      font-weight: 600;
      color: #111;
    }
    #result {
      font-size: 20px;
      height: 28px;
      margin-bottom: 15px;
      font-weight: 600;
    }
    #resultList h2 {
      margin-bottom: 20px;
    }
    #resultsUl {
      list-style-type: none;
      padding-left: 0;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
    }
    #resultsUl li {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      font-size: 16px;
      line-height: 1.3;
    }
    #resultsUl li.correct {
      color: #059669; /* ç·‘ */
      background-color: #d1fae5;
    }
    #resultsUl li.incorrect {
      color: #dc2626; /* èµ¤ */
      background-color: #fee2e2;
    }
    #reviewBtn {
      margin-top: 15px;
      background-color: #ef4444;
    }
    #reviewBtn:hover {
      background-color: #b91c1c;
    }
    #backBtn {
      background-color: #6b7280;
      margin-top: 25px;
    }
    #backBtn:hover {
      background-color: #374151;
    }
    .correct {
      color: green;
      font-weight: bold;
    }
    .incorrect {
      color: red;
      font-weight: bold;
    }

    /* ğŸ”¹å˜èªã‚’éè¡¨ç¤ºã«ã™ã‚‹ãŒä½™ç™½ã‚’ä¿ã¤ */
  .hidden-word {
    color: transparent !important;
    user-select: none;
    transition: color 0.4s ease !important;
  }

/* ğŸ”¹ç­”ãˆãŸã‚ã¨ã«è¡¨ç¤ºï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼‰ */
  .revealed {
    color: #111;
  }

    
    @media (max-width: 480px) {
      body {
        margin: 20px 10px;
        font-size: 14px;
      }
      #levelArea, #quizArea, #resultList {
        padding: 15px 20px;
        max-width: 100%;
      }
      #answer {
        width: 90%;
        max-width: none;
        font-size: 16px;
        padding: 8px 10px;
      }
      button {
        width: 90%;
        font-size: 16px;
        padding: 12px 0;
        margin: 10px auto;
        display: block;
      }
      #question {
        font-size: 22px;
      }
      #progress {
        font-size: 16px;
      }
      #result {
        font-size: 18px;
      }
      #resultsUl li {
        font-size: 14px;
        padding: 10px 12px;
      }
    }
    /* ğŸ”ˆ è‹±èªéŸ³å£°å†ç”Ÿãƒœã‚¿ãƒ³ */
#speakBtn {
  background: none;
  border: none;
  font-size: 22px;
  color: #3b82f6;
  cursor: pointer;
  padding: 0;
  margin: 0;
  line-height: 1;
  transition: transform 0.15s ease, color 0.15s ease, opacity 0.15s ease;
}

#speakBtn:hover {
  color: #2563eb;
  transform: scale(1.2);
  opacity: 0.9;
}

#speakBtn:active {
  transform: scale(0.9);
}

/* ğŸ§ å†ç”Ÿä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
#speakBtn.speaking {
  color: #22c55e; /* ç·‘è‰² */
  animation: pulse 0.8s infinite;
}

/* ğŸ”ˆ çµæœç”»é¢ç”¨ã®å°ã•ã„éŸ³å£°ãƒœã‚¿ãƒ³ */
.speak-small-btn {
  background: none;
  border: none;
  font-size: 18px;
  color: #3b82f6;
  cursor: pointer;
  margin-left: 6px;
  padding: 0;
  transition: transform 0.15s ease, color 0.15s ease;
}

.speak-small-btn:hover {
  color: #2563eb;
  transform: scale(1.2);
}

.speak-small-btn:active {
  transform: scale(0.9);
}

@media (max-width: 480px) {
  .speak-small-btn {
    font-size: 16px;
    margin-left: 4px;
  }
}


@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.3); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}

@media (max-width: 480px) {
  #speakBtn {
    font-size: 20px;
  }
}


  </style>
</head>
<body>

<div id="levelArea">
  <h1>ç¯„å›²ï¼†ãƒ¢ãƒ¼ãƒ‰é¸æŠ</h1>
  <div id="inputModeArea" style="margin-bottom: 20px;">
    <label><input type="radio" name="inputMode" value="normal" checked> é€šå¸¸</label>
    <label><input type="radio" name="inputMode" value="sound"> éŸ³å£°ã®ã¿</label>
  </div>
  
  <div id="modeSelector" style="margin-bottom: 20px;">
    <label><input type="radio" name="mode" value="word" checked> å˜èªã®ã¿</label>
    <label><input type="radio" name="mode" value="both"> ç†Ÿèªã¨å˜èª</label>
    <label><input type="radio" name="mode" value="idiom"> ç†Ÿèªã®ã¿</label>
  </div>

  <h2>å˜èª 1ã€œ1700</h2>
  <script>
    for (let level = 1; level <= 17; level++) {
      const startNum = (level - 1) * 100 + 1;
      const midNum = startNum + 49;
      const endNum = level * 100;
      const jsonFile = `words_level${level}.json`;
      document.write(`<h3>å˜èª ${startNum}ã€œ${endNum} ï¼ˆlevel${level}ï¼‰</h3>`);
      document.write(`<button onclick="loadWords('${jsonFile}', ${startNum}, ${midNum}, ${level})">å˜èª ${startNum}ã€œ${midNum}</button>`);
      document.write(`<button onclick="loadWords('${jsonFile}', ${midNum + 1}, ${endNum}, ${level})">å˜èª ${midNum + 1}ã€œ${endNum}</button>`);
    }
  </script>
</div>

<div id="quizArea" style="display:none;">
  <p id="levelDisplay">ãƒ¬ãƒ™ãƒ«: -</p>
  <p id="progress">0 / 0</p>
  <button id="speakBtn" onclick="speakEnglish(document.getElementById('question').textContent)" title="ç™ºéŸ³ã‚’èã">
    ğŸ”ˆ
  </button>
  <p id="question">å˜èªãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>

  <input type="text" id="answer" placeholder="æ—¥æœ¬èªã§ç­”ãˆã¦ãã ã•ã„" autocomplete="off" />
  <br />
  <button id="answerBtn" onclick="checkAnswer()">ç­”ãˆã‚‹</button>
  <p id="result"></p>
  <button id="backBtn" onclick="goBack()">â† ãƒ¬ãƒ™ãƒ«é¸æŠã«æˆ»ã‚‹</button>
</div>

<div id="resultList" style="display:none;">
  <h2>çµæœä¸€è¦§</h2>
  <ul id="resultsUl"></ul>
  <button id="reviewBtn" style="display:none;" onclick="reviewWrong()">é–“é•ã£ãŸå•é¡Œã‚’å¾©ç¿’ã™ã‚‹</button>
  <br />
  <button id="backBtn" onclick="goBack()">â† ãƒ¬ãƒ™ãƒ«é¸æŠã«æˆ»ã‚‹</button>
</div>

<script>
let words = [];
let current = 0;
let correct = 0;
let answersLog = [];
let currentLevel = 0;

function levenshtein(a, b) {
  const matrix = [];
  for (let i = 0; i <= b.length; i++) matrix[i] = [i];
  for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      matrix[i][j] = b.charAt(i-1) === a.charAt(j-1)
        ? matrix[i-1][j-1]
        : Math.min(matrix[i-1][j-1] + 1, matrix[i][j-1] + 1, matrix[i-1][j] + 1);
    }
  }
  return matrix[b.length][a.length];
}

async function loadWords(file, startId, endId, level) {
  currentLevel = level;
  const res = await fetch(file);
  const data = await res.json();
  const selectedMode = document.querySelector('input[name="mode"]:checked').value;
  words = data.filter(word => {
    if (word.id < startId || word.id > endId) return false;
    if (selectedMode === "idiom") return word.idiom;
    if (selectedMode === "word") return !word.idiom;
    return true;
  });
  shuffle(words);
  current = 0;
  correct = 0;
  answersLog = [];

  document.getElementById("levelDisplay").textContent = `ãƒ¬ãƒ™ãƒ«: ${currentLevel}`;
  document.getElementById("levelArea").style.display = "none";
  document.getElementById("resultList").style.display = "none";
  document.getElementById("quizArea").style.display = "block";
  showQuestion();
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function showQuestion() {
  if (current >= words.length) {
    showResultList();
    return;
  }

  const currentWord = words[current].en; // ä»Šå›å‡ºé¡Œã™ã‚‹å˜èª
  const inputMode = document.querySelector('input[name="inputMode"]:checked').value;
  const questionElem = document.getElementById("question");

  // ã¾ãšéè¡¨ç¤ºçŠ¶æ…‹ã«ã™ã‚‹
  questionElem.classList.add("hidden-word");
  questionElem.classList.remove("revealed");

  // å˜èªã‚’ã‚»ãƒƒãƒˆï¼ˆéè¡¨ç¤ºçŠ¶æ…‹ã§ï¼‰
  questionElem.textContent = currentWord;

  // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ãªã‚‰å°‘ã—ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
  if (inputMode !== "sound") {
    setTimeout(() => {
      questionElem.classList.remove("hidden-word");
      questionElem.classList.add("revealed");
    }, 10); // 10msã§ã‚¯ãƒ©ã‚¹åˆ‡æ›¿ã€CSSã® transition ã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
  }

  document.getElementById("progress").textContent = (current + 1) + " / " + words.length;
  document.getElementById("result").textContent = "";
  document.getElementById("answer").value = "";
  document.getElementById("answer").focus();

  // éŸ³å£°å†ç”Ÿ
  speakEnglish(currentWord);
}




function removeParentheses(str) {
  return str.replace(/[\(\ï¼ˆ].*?[\)\ï¼‰]/g, "").trim();
}

async function getSimilarity(text1, text2) {
  const response = await fetch("https://english-quiz-smoky.vercel.app/api/hf-proxy", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ inputs: { source_sentence: text1, sentences: [text2] } })
  });
  const data = await response.json();
  if (!Array.isArray(data) || typeof data[0] !== "number") return 0;
  return data[0];
}

// ğŸ”¹é€£æ‰“é˜²æ­¢ä»˜ã checkAnswer
async function checkAnswer() {
  const answerBtn = document.getElementById("answerBtn");
  answerBtn.disabled = true;

  const userAnswer = document.getElementById("answer").value.trim().toLowerCase();
  const correctAnswers = words[current].jp;
  const resultElem = document.getElementById("result");
  const questionElem = document.getElementById("question");

  // ğŸ”¸éŸ³å£°ãƒ¢ãƒ¼ãƒ‰ãªã‚‰å˜èªã‚’è¡¨ç¤ºã•ã›ã‚‹
  if (questionElem.classList.contains("hidden-word")) {
    questionElem.classList.remove("hidden-word");
    questionElem.classList.add("revealed");
  }

  if (userAnswer.length === 0) {
    resultElem.textContent = `ï½˜ (${correctAnswers.join(", ")})`;
    resultElem.className = "incorrect";
    answersLog.push({
      en: words[current].en,
      correctAnswer: correctAnswers.join(", "),
      userAnswer,
      isCorrect: false,
      id: words[current].id,
      jp: correctAnswers
    });
    current++;
    setTimeout(() => {
      answerBtn.disabled = false;
      showQuestion();
    }, 1000);
    return;
  }

  // âœ… æ­£èª¤åˆ¤å®š
  let isCorrect = false;
  for (const ans of correctAnswers) {
    const cleaned = removeParentheses(ans).toLowerCase();
    const similarity = await getSimilarity(userAnswer, cleaned);
    if (similarity >= 0.85) {
      isCorrect = true;
      break;
    }
  }

  if (isCorrect) {
    correct++;
    resultElem.textContent = `ã€‡ (${correctAnswers.join(", ")})`;
    resultElem.className = "correct";
  } else {
    resultElem.textContent = `ï½˜ (${correctAnswers.join(", ")})`;
    resultElem.className = "incorrect";
  }

  answersLog.push({
    en: words[current].en,
    correctAnswer: correctAnswers.join(", "),
    userAnswer,
    isCorrect,
    id: words[current].id,
    jp: correctAnswers
  });

  current++;
  setTimeout(() => {
    answerBtn.disabled = false;
    showQuestion();
  }, 1000);
}


function showResultList() {
  document.getElementById("quizArea").style.display = "none";
  const resultDiv = document.getElementById("resultList");
  const ul = document.getElementById("resultsUl");
  ul.innerHTML = "";

  answersLog.forEach((item, i) => {
    const li = document.createElement("li");
    li.className = item.isCorrect ? "correct" : "incorrect";

    // ğŸ”¹è‹±å˜èªãƒ†ã‚­ã‚¹ãƒˆ
    const textSpan = document.createElement("span");
    textSpan.textContent = `${i + 1}. ${item.en} â€” ã‚ãªãŸã®ç­”ãˆ: "${item.userAnswer || 'æœªå›ç­”'}" â€” æ­£è§£: "${item.correctAnswer}"`;

    // ğŸ”¹å†ç”Ÿãƒœã‚¿ãƒ³
    const speakBtn = document.createElement("button");
    speakBtn.textContent = "ğŸ”ˆ";
    speakBtn.className = "speak-small-btn";
    speakBtn.title = "ç™ºéŸ³ã‚’èã";
    speakBtn.onclick = () => speakEnglish(item.en);

    // ğŸ”¹ãƒªã‚¹ãƒˆã«è¿½åŠ 
    li.appendChild(textSpan);
    li.appendChild(speakBtn);
    ul.appendChild(li);
  });

  const wrongCount = answersLog.filter(x => !x.isCorrect).length;
  document.getElementById("reviewBtn").style.display = wrongCount > 0 ? "inline-block" : "none";
  resultDiv.style.display = "block";
}


function reviewWrong() {
  words = answersLog.filter(x => !x.isCorrect).map(x => ({ id: x.id, en: x.en, jp: x.jp }));
  shuffle(words);
  current = 0; correct = 0; answersLog = [];
  document.getElementById("resultList").style.display = "none";
  document.getElementById("quizArea").style.display = "block";
  showQuestion();
}

function goBack() {
  document.getElementById("quizArea").style.display = "none";
  document.getElementById("resultList").style.display = "none";
  document.getElementById("levelArea").style.display = "block";
  document.getElementById("result").textContent = "";
  const answerInput = document.getElementById("answer");
  answerInput.value = "";
  answerInput.style.display = "inline";
  document.getElementById("answerBtn").style.display = "inline";
}

// ğŸ”¹Enterã‚­ãƒ¼ã§ã‚‚é€£æ‰“é˜²æ­¢ãƒã‚§ãƒƒã‚¯
document.getElementById("answer").addEventListener("keydown", e => {
  const btn = document.getElementById("answerBtn");
  if (e.key === "Enter" && !btn.disabled) {
    e.preventDefault();
    checkAnswer();
  }
});

document.body.addEventListener("click", e => {
  const tag = e.target.tagName.toLowerCase();
  if (!["input", "button", "select", "textarea", "label", "a"].includes(tag)) {
    const ans = document.getElementById("answer");
    if (ans && ans.offsetParent !== null) ans.focus();
  }
});

const modeSelector = document.querySelectorAll('input[name="mode"]');
modeSelector.forEach(radio => {
  radio.addEventListener('change', async () => {
    const selectedMode = document.querySelector('input[name="mode"]:checked').value;
    for (let level = 1; level <= 17; level++) {
      const file = `words_level${level}.json`;
      const res = await fetch(file);
      const data = await res.json();
      const startNum = (level - 1) * 100 + 1;
      const midNum = startNum + 49;
      const endNum = level * 100;
      const ranges = [
        { start: startNum, end: midNum },
        { start: midNum + 1, end: endNum }
      ];
      ranges.forEach(range => {
        const hasIdiom = data.some(w => w.idiom && w.id >= range.start && w.id <= range.end);
        const hasWord = data.some(w => !w.idiom && w.id >= range.start && w.id <= range.end);
        const btnText = `å˜èª ${range.start}ã€œ${range.end}`;
        const btns = Array.from(document.querySelectorAll('button')).filter(b => b.textContent === btnText);
        btns.forEach(btn => {
          if (selectedMode === 'idiom' && !hasIdiom) {
            btn.disabled = true; btn.style.opacity = 0.5; btn.title = 'ã“ã®ç¯„å›²ã«ã¯ç†ŸèªãŒã‚ã‚Šã¾ã›ã‚“';
          } else if (selectedMode === 'word' && !hasWord) {
            btn.disabled = true; btn.style.opacity = 0.5; btn.title = 'ã“ã®ç¯„å›²ã«ã¯å˜èªãŒã‚ã‚Šã¾ã›ã‚“';
          } else {
            btn.disabled = false; btn.style.opacity = 1; btn.title = '';
          }
        });
      });
    }
  });
});
modeSelector[0].dispatchEvent(new Event('change'));

  // ===== è‹±èªéŸ³å£°ã‚’å†ç”Ÿã™ã‚‹é–¢æ•° =====
function speakEnglish(text) {
  if (!('speechSynthesis' in window)) {
    console.warn('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
    return;
  }

  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'en-US';     // è‹±èª
  utter.rate = 0.9;         // è©±ã™é€Ÿã•ï¼ˆ1ãŒæ™®é€šã€å°‘ã—ã‚†ã£ãã‚Šï¼‰
  utter.pitch = 1;          // å£°ã®é«˜ã•

  // è‹±èªã®å£°ã‚’å„ªå…ˆã—ã¦é¸æŠï¼ˆä¾‹ï¼šGoogle US Englishãªã©ï¼‰
  const voices = speechSynthesis.getVoices();
  const enVoice = voices.find(v => v.lang.startsWith('en'));
  if (enVoice) utter.voice = enVoice;

  speechSynthesis.cancel(); // å‰ã®éŸ³å£°ãŒæ®‹ã£ã¦ãŸã‚‰æ­¢ã‚ã‚‹
  speechSynthesis.speak(utter);
}

</script>
</body>
</html>








